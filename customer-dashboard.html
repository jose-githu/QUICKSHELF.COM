<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Quickshelf</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; color: #2d3748; }

        .floating-order-btn {
            position: fixed; bottom: 30px; right: 30px; width: 200px; height: 65px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 35px; font-size: 19px; font-weight: bold;
            cursor: pointer; box-shadow: 0 8px 25px rgba(102,126,234,0.5); z-index: 1000;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: all 0.3s; animation: pulse 2s infinite;
        }
        .floating-order-btn:hover { transform: translateY(-5px) scale(1.08); box-shadow: 0 12px 35px rgba(102,126,234,0.7); }
        @keyframes pulse { 0%,100% { box-shadow: 0 8px 25px rgba(102,126,234,0.5); } 50% { box-shadow: 0 8px 35px rgba(102,126,234,0.8); } }

        .top-nav { background: white; padding: 20px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 999; }
        .logo { font-size: 28px; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-menu { display: flex; align-items: center; gap: 25px; }
        .user-info { display: flex; align-items: center; gap: 15px; padding: 10px 20px; background: #f7fafc; border-radius: 25px; }
        .user-avatar { width: 45px; height: 45px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold; }
        .user-details h4 { font-size: 15px; margin-bottom: 2px; }
        .user-details p { font-size: 12px; color: #718096; }
        .logout-btn { background: #fff; border: 2px solid #e2e8f0; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568; transition: all 0.3s; }
        .logout-btn:hover { background: #f56565; color: white; border-color: #f56565; }

        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }

        .welcome-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; margin-bottom: 40px; text-align: center; }
        .welcome-section h1 { font-size: 42px; margin-bottom: 10px; }
        .welcome-section p { font-size: 18px; opacity: 0.95; }

        .nav-tabs { display: flex; gap: 15px; margin-bottom: 35px; flex-wrap: wrap; justify-content: center; }
        .nav-tab { background: white; padding: 18px 35px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s; border: 3px solid transparent; display: flex; align-items: center; gap: 10px; }
        .nav-tab:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; }

        .page-section { display: none; }
        .page-section.active { display: block; }

        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .analysis-card { background: white; padding: 35px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; transition: all 0.3s; border-left: 6px solid #e2e8f0; cursor: pointer; }
        .analysis-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .analysis-card.received { border-left-color: #48bb78; }
        .analysis-card.pending { border-left-color: #f59e0b; }
        .analysis-card.cancelled { border-left-color: #f56565; }
        .analysis-icon { width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .analysis-card.received .analysis-icon { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; }
        .analysis-card.pending .analysis-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .analysis-card.cancelled .analysis-icon { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; }
        .analysis-number { font-size: 56px; font-weight: bold; margin-bottom: 10px; }
        .analysis-label { font-size: 20px; color: #718096; font-weight: 600; margin-bottom: 5px; }
        .analysis-sublabel { font-size: 14px; color: #a0aec0; }

        .orders-container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .section-title { font-size: 26px; font-weight: bold; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; }

        .order-item { background: #f7fafc; padding: 25px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #e2e8f0; transition: all 0.3s; cursor: pointer; }
        .order-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); transform: translateX(5px); }
        .order-item.received { border-left-color: #48bb78; background: #f0fff4; }
        .order-item.pending { border-left-color: #f59e0b; background: #fffbeb; }
        .order-item.cancelled { border-left-color: #f56565; background: #fff5f5; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .order-id { font-size: 18px; font-weight: bold; }
        .order-badge { padding: 8px 20px; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .badge-received { background: #48bb78; color: white; }
        .badge-pending { background: #f59e0b; color: white; }
        .badge-cancelled { background: #f56565; color: white; }
        .order-details { color: #4a5568; line-height: 1.8; margin-bottom: 15px; }
        .order-details strong { color: #2d3748; }
        .order-actions { display: flex; gap: 12px; flex-wrap: wrap; }

        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .btn-secondary { background: #e2e8f0; color: #4a5568; }
        .btn-secondary:hover { background: #cbd5e0; }
        .btn-danger { background: #fed7d7; color: #c53030; }
        .btn-danger:hover { background: #f56565; color: white; }

        .account-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; }
        .account-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-header { font-size: 22px; font-weight: bold; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #e2e8f0; display: flex; align-items: center; gap: 10px; }
        .info-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f7fafc; }
        .info-label { color: #718096; font-weight: 600; }
        .info-value { color: #2d3748; font-weight: 600; }
        .edit-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 20px; width: 100%; font-size: 16px; transition: all 0.3s; }
        .edit-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 40px; border-radius: 20px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: modalSlide 0.3s; }
        @keyframes modalSlide { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #e2e8f0; }
        .modal-title { font-size: 28px; font-weight: bold; }
        .modal-close { background: #e2e8f0; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .modal-close:hover { background: #f56565; color: white; transform: rotate(90deg); }
        .detail-section { margin-bottom: 25px; padding: 20px; background: #f7fafc; border-radius: 12px; }
        .detail-section h4 { font-size: 18px; margin-bottom: 15px; color: #2d3748; }
        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: #718096; font-weight: 600; }
        .detail-value { color: #2d3748; font-weight: bold; }

        .empty-state { text-align: center; padding: 60px 20px; color: #a0aec0; }
        .empty-icon { font-size: 80px; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { font-size: 28px; margin-bottom: 12px; color: #4a5568; }
        .empty-state p { font-size: 16px; margin-bottom: 25px; }

        .loading-state { text-align: center; padding: 60px 20px; color: #718096; }
        .spinner { display: inline-block; width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .notification { position: fixed; top: 100px; right: 30px; background: #48bb78; color: white; padding: 18px 25px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); z-index: 10000; display: none; font-weight: 600; animation: slideIn 0.4s; min-width: 300px; }
        .notification.show { display: block; }
        .notification.error { background: #f56565; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        @media (max-width: 768px) {
            .top-nav { padding: 15px 20px; }
            .welcome-section h1 { font-size: 30px; }
            .nav-tabs { flex-direction: column; }
            .nav-tab { width: 100%; justify-content: center; }
            .floating-order-btn { width: 160px; height: 55px; font-size: 16px; bottom: 20px; right: 20px; }
            .account-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 25px; }
        }
    </style>
</head>
<body>

<button class="floating-order-btn" onclick="goToCatalogue()">üõçÔ∏è Make an Order</button>

<nav class="top-nav">
    <div class="logo" onclick="goHome()"><span>üì¶</span><span>Quickshelf</span></div>
    <div class="user-menu">
        <div class="user-info">
            <div class="user-avatar" id="userInitials">U</div>
            <div class="user-details">
                <h4 id="displayName">Loading...</h4>
                <p id="displayPhone">Loading...</p>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</nav>

<div class="container">
    <div class="welcome-section">
        <h1>Welcome Back, <span id="welcomeName">User</span>! üëã</h1>
        <p>Track your orders, manage your account, and shop with ease</p>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="showSection('dashboard')" data-section="dashboard"><span>üìä</span> Order Dashboard</div>
        <div class="nav-tab" onclick="showSection('account')" data-section="account"><span>üë§</span> My Account</div>
        <div class="nav-tab" onclick="showSection('history')" data-section="history"><span>üìú</span> Order History</div>
    </div>

    <!-- Dashboard -->
    <div class="page-section active" id="dashboard">
        <div class="analysis-grid">
            <div class="analysis-card received" onclick="filterOrders('received')">
                <div class="analysis-icon">‚úÖ</div>
                <div class="analysis-number" id="receivedCount">0</div>
                <div class="analysis-label">Orders Received</div>
                <div class="analysis-sublabel">Successfully delivered</div>
            </div>
            <div class="analysis-card pending" onclick="filterOrders('pending')">
                <div class="analysis-icon">‚è≥</div>
                <div class="analysis-number" id="pendingCount">0</div>
                <div class="analysis-label">Pending Orders</div>
                <div class="analysis-sublabel">Currently being processed</div>
            </div>
            <div class="analysis-card cancelled" onclick="filterOrders('cancelled')">
                <div class="analysis-icon">‚ùå</div>
                <div class="analysis-number" id="cancelledCount">0</div>
                <div class="analysis-label">Cancelled Orders</div>
                <div class="analysis-sublabel">Orders that were cancelled</div>
            </div>
        </div>
        <div class="orders-container">
            <h2 class="section-title"><span>üìã</span> Recent Orders</h2>
            <div id="recentOrdersList"><div class="loading-state"><div class="spinner"></div><p>Loading your orders...</p></div></div>
        </div>
    </div>

    <!-- Account -->
    <div class="page-section" id="account">
        <div class="account-grid">
            <div class="account-card">
                <h3 class="card-header"><span>üë§</span> Personal Information</h3>
                <div class="info-row"><span class="info-label">Full Name</span><span class="info-value" id="accountName">‚Äî</span></div>
                <div class="info-row"><span class="info-label">Phone Number</span><span class="info-value" id="accountPhone">‚Äî</span></div>
                <div class="info-row"><span class="info-label">Email</span><span class="info-value" id="accountEmail">‚Äî</span></div>
                <div class="info-row"><span class="info-label">Member Since</span><span class="info-value" id="memberSince">‚Äî</span></div>
                <button class="edit-btn" onclick="editProfile()">‚úèÔ∏è Edit Profile</button>
            </div>
            <div class="account-card">
                <h3 class="card-header"><span>üìä</span> Statistics</h3>
                <div class="info-row"><span class="info-label">Total Orders</span><span class="info-value" id="statTotalOrders">0</span></div>
                <div class="info-row"><span class="info-label">Delivered</span><span class="info-value" id="statDelivered">0</span></div>
                <div class="info-row"><span class="info-label">Pending</span><span class="info-value" id="statPending">0</span></div>
                <div class="info-row"><span class="info-label">Last Order</span><span class="info-value" id="statLastOrder">Never</span></div>
            </div>
            <div class="account-card">
                <h3 class="card-header"><span>‚ö°</span> Quick Actions</h3>
                <button class="edit-btn" onclick="goToCatalogue()" style="margin-bottom:15px;">üõçÔ∏è Make New Order</button>
                <button class="edit-btn" onclick="showSection('history')" style="margin-bottom:15px;">üìú Order History</button>
                <button class="edit-btn" onclick="contactSupport()">üí¨ Contact Support</button>
            </div>
        </div>
    </div>

    <!-- History -->
    <div class="page-section" id="history">
        <div class="orders-container">
            <h2 class="section-title"><span>üìú</span> <span id="historyTitle">Complete Order History</span></h2>
            <div id="fullOrdersList"><div class="loading-state"><div class="spinner"></div><p>Loading...</p></div></div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal" id="orderDetailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">üì¶ Order Details</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
    // ============================================================
    // BACKEND CONFIG ‚Äî same URL used by index.html
    // ============================================================
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbw0ottrIns0t_ecJ6JwesPNee38Qx09OKuCv4wMY1fcfxkL0Cle1ZElPGivmhgAtYc6/exec';

    async function apiCall(action, data = {}) {
        try {
            const res = await fetch(API_BASE_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action, ...data })
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (err) {
            console.error('API Error:', err);
            return { success: false, message: 'Connection error.' };
        }
    }

    // ============================================================
    // SESSION ‚Äî matches exactly what index.html saves
    // ============================================================
    function store(key) { try { return localStorage.getItem(key); } catch(e) { return null; } }
    function storeSet(key, val) { try { localStorage.setItem(key, val); } catch(e) {} }
    function storeRemove(key) { try { localStorage.removeItem(key); } catch(e) {} }

    // Guard: kick out if not a logged-in customer
    if (store('quickshelfLoggedIn') !== 'true' || store('quickshelfUserType') !== 'customer') {
        window.location.href = 'index.html';
    }

    const sessionPhone = store('quickshelfUserPhone') || '';
    const sessionRaw   = JSON.parse(store('quickshelfUserData') || '{}');

    const customerData = {
        name:  sessionRaw.name || sessionRaw.fullName || 'Customer',
        phone: sessionRaw.phone || sessionRaw.phoneNumber || sessionPhone,
        email: sessionRaw.email || '',
        joinDate: sessionRaw.joinDate || sessionRaw.createdAt || '',
    };

    let orders = [];

    // ============================================================
    // INIT
    // ============================================================
    async function initDashboard() {
        // Header
        document.getElementById('displayName').textContent  = customerData.name;
        document.getElementById('displayPhone').textContent = customerData.phone;
        document.getElementById('welcomeName').textContent  = customerData.name.split(' ')[0];
        document.getElementById('userInitials').textContent = getInitials(customerData.name);

        // Account tab
        document.getElementById('accountName').textContent  = customerData.name;
        document.getElementById('accountPhone').textContent = customerData.phone;
        document.getElementById('accountEmail').textContent = customerData.email || '‚Äî';
        document.getElementById('memberSince').textContent  = customerData.joinDate
            ? new Date(customerData.joinDate).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
            : 'N/A';

        await fetchOrders();
    }

    async function fetchOrders() {
        const res = await apiCall('getCustomerOrders', { phone: customerData.phone });
        orders = (res.success && Array.isArray(res.orders)) ? res.orders : [];
        renderAll();
    }

    // ============================================================
    // RENDER
    // ============================================================
    function statusNorm(raw) {
        const s = (raw || '').toLowerCase().trim();
        if (['received','delivered','completed'].includes(s)) return 'received';
        if (['cancelled','canceled'].includes(s)) return 'cancelled';
        return 'pending';
    }

    function renderAll() {
        const received  = orders.filter(o => statusNorm(o.status) === 'received').length;
        const pending   = orders.filter(o => statusNorm(o.status) === 'pending').length;
        const cancelled = orders.filter(o => statusNorm(o.status) === 'cancelled').length;

        document.getElementById('receivedCount').textContent  = received;
        document.getElementById('pendingCount').textContent   = pending;
        document.getElementById('cancelledCount').textContent = cancelled;

        const lastDate = orders.length
            ? new Date(orders[0].date || orders[0].createdAt || Date.now())
                .toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' })
            : 'Never';

        document.getElementById('statTotalOrders').textContent = orders.length;
        document.getElementById('statDelivered').textContent   = received;
        document.getElementById('statPending').textContent     = pending;
        document.getElementById('statLastOrder').textContent   = lastDate;

        renderList('recentOrdersList', orders.slice(0, 3));
        renderList('fullOrdersList', orders);
    }

    function renderList(id, list) {
        const el = document.getElementById(id);
        if (!list || list.length === 0) {
            el.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <h3>No Orders Yet</h3>
                    <p>You haven't placed any orders yet. Start shopping now!</p>
                    <button class="btn btn-primary" onclick="goToCatalogue()" style="margin-top:20px;padding:15px 40px;font-size:18px;">üõçÔ∏è Start Shopping</button>
                </div>`;
            return;
        }
        el.innerHTML = list.map(o => orderCard(o)).join('');
    }

    function orderCard(o) {
        const status    = statusNorm(o.status);
        const labels    = { received: 'Delivered', pending: 'Processing', cancelled: 'Cancelled' };
        const icons     = { received: '‚úÖ', pending: '‚è≥', cancelled: '‚ùå' };
        const oid       = o.id || o.orderId || o.orderID || '‚Äî';
        const rawItems  = o.items || o.products || o.itemsList || '';
        const items     = Array.isArray(rawItems) ? rawItems.map(i => i.name || i.product || i).join(', ') : String(rawItems);
        const total     = o.total || o.amount || o.totalAmount || 0;
        const rawDate   = o.date || o.createdAt || o.orderDate || '';
        const dateStr   = rawDate ? new Date(rawDate).toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) : '‚Äî';

        return `
        <div class="order-item ${status}" onclick="viewOrder('${oid}')">
            <div class="order-header">
                <div class="order-id">${icons[status]} ${oid}</div>
                <span class="order-badge badge-${status}">${labels[status]}</span>
            </div>
            <div class="order-details">
                <p><strong>üìÖ Date:</strong> ${dateStr}</p>
                ${items  ? `<p><strong>üì¶ Items:</strong> ${items}</p>` : ''}
                ${total  ? `<p><strong>üí∞ Total:</strong> KES ${Number(total).toLocaleString()}</p>` : ''}
            </div>
            <div class="order-actions" onclick="event.stopPropagation()">
                ${status === 'pending'  ? `<button class="btn btn-primary" onclick="trackOrder('${oid}')">üìç Track</button>` : ''}
                ${status === 'received' ? `<button class="btn btn-primary" onclick="reorder('${oid}')">üîÑ Reorder</button>` : ''}
                ${status === 'pending'  ? `<button class="btn btn-danger"  onclick="cancelOrder('${oid}')">‚ùå Cancel</button>` : ''}
                <button class="btn btn-secondary" onclick="viewOrder('${oid}')">üëÅÔ∏è Details</button>
            </div>
        </div>`;
    }

    function viewOrder(oid) {
        const o = orders.find(x => (x.id || x.orderId || x.orderID) === oid);
        if (!o) return;
        const status   = statusNorm(o.status);
        const labels   = { received: '‚úÖ Delivered', pending: '‚è≥ Processing', cancelled: '‚ùå Cancelled' };
        const rawItems = o.items || o.products || o.itemsList || '';
        const total    = o.total || o.amount || o.totalAmount || 0;
        const rawDate  = o.date || o.createdAt || o.orderDate || '';
        const itemsHTML = Array.isArray(rawItems)
            ? rawItems.map(i => `<div class="detail-row"><span class="detail-label">${i.name||i.product||i}${i.quantity?` x${i.quantity}`:''}</span><span class="detail-value">${i.price?`KES ${(i.price*(i.quantity||1)).toLocaleString()}`:''}</span></div>`).join('')
            : `<div class="detail-row"><span class="detail-label">${rawItems}</span><span></span></div>`;

        document.getElementById('modalBody').innerHTML = `
            <div class="detail-section">
                <h4>üìã Order Info</h4>
                <div class="detail-row"><span class="detail-label">Order ID</span><span class="detail-value">${oid}</span></div>
                <div class="detail-row"><span class="detail-label">Date</span><span class="detail-value">${rawDate ? new Date(rawDate).toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}) : '‚Äî'}</span></div>
                <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value">${labels[status]}</span></div>
                ${o.trackingNumber ? `<div class="detail-row"><span class="detail-label">Tracking #</span><span class="detail-value">${o.trackingNumber}</span></div>` : ''}
                ${(o.deliveryAddress||o.shippingAddress) ? `<div class="detail-row"><span class="detail-label">Delivery To</span><span class="detail-value">${o.deliveryAddress||o.shippingAddress}</span></div>` : ''}
            </div>
            <div class="detail-section">
                <h4>üì¶ Items</h4>
                ${itemsHTML}
                ${total ? `<div class="detail-row" style="border-top:3px solid #e2e8f0;margin-top:10px;padding-top:10px;"><span class="detail-label" style="font-size:18px;">TOTAL</span><span class="detail-value" style="font-size:20px;color:#667eea;">KES ${Number(total).toLocaleString()}</span></div>` : ''}
            </div>
            ${o.paymentMethod ? `<div class="detail-section"><h4>üí≥ Payment</h4><div class="detail-row"><span class="detail-label">Method</span><span class="detail-value">${o.paymentMethod}</span></div></div>` : ''}
            <div style="display:flex;gap:12px;margin-top:30px;flex-wrap:wrap;">
                ${status==='pending'  ? `<button class="btn btn-primary" style="flex:1" onclick="trackOrder('${oid}');closeModal()">üìç Track</button>` : ''}
                ${status==='received' ? `<button class="btn btn-primary" style="flex:1" onclick="reorder('${oid}');closeModal()">üîÑ Reorder</button>` : ''}
                <button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Close</button>
            </div>`;
        document.getElementById('orderDetailsModal').classList.add('active');
    }

    function closeModal() { document.getElementById('orderDetailsModal').classList.remove('active'); }

    // ============================================================
    // ACTIONS
    // ============================================================
    function filterOrders(status) {
        showSection('history');
        const map = { received:'Received Orders', pending:'Pending Orders', cancelled:'Cancelled Orders' };
        document.getElementById('historyTitle').textContent = map[status];
        renderList('fullOrdersList', orders.filter(o => statusNorm(o.status) === status));
        showNotification(`Showing ${map[status].toLowerCase()}`);
    }

    function showSection(id) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.section === id));
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id === 'history') {
            document.getElementById('historyTitle').textContent = 'Complete Order History';
            renderList('fullOrdersList', orders);
        }
    }

    async function cancelOrder(oid) {
        const reason = prompt('Why are you cancelling this order?\n(Changed my mind / Ordered by mistake / Other)');
        if (!reason || !reason.trim()) return;
        if (!confirm(`Cancel order ${oid}? This cannot be undone.`)) return;
        showNotification('Cancelling order...');
        const res = await apiCall('cancelOrder', { orderId: oid, phone: customerData.phone, reason: reason.trim() });
        if (res.success) {
            showNotification(`‚úÖ Order ${oid} cancelled`);
            await fetchOrders();
        } else {
            showNotification(res.message || 'Could not cancel. Please contact support.', true);
        }
    }

    function trackOrder(oid) {
        const o = orders.find(x => (x.id||x.orderId||x.orderID) === oid);
        if (!o) return;
        const tracking = o.trackingNumber ? `Tracking #: ${o.trackingNumber}` : 'Tracking not available yet.';
        const eta = o.estimatedDelivery ? `\nExpected: ${new Date(o.estimatedDelivery).toLocaleDateString()}` : '';
        showNotification(`üìç ${oid} ‚Äî ${tracking}`);
        setTimeout(() => alert(`TRACKING: ${oid}\n${tracking}${eta}\n\nContact us on WhatsApp for live updates.`), 500);
    }

    function reorder(oid) {
        showNotification('üîÑ Redirecting to catalogue...');
        setTimeout(() => goToCatalogue(), 1200);
    }

    async function editProfile() {
        const newName = prompt('Full Name:', customerData.name);
        if (!newName || !newName.trim()) return;
        const res = await apiCall('updateCustomerProfile', { phone: customerData.phone, name: newName.trim() });
        if (res.success) {
            customerData.name = newName.trim();
            storeSet('quickshelfUserData', JSON.stringify({ ...sessionRaw, name: customerData.name }));
            initDashboard();
            showNotification('‚úÖ Profile updated!');
        } else {
            showNotification(res.message || 'Update failed.', true);
        }
    }

    function goToCatalogue() {
        showNotification('üõçÔ∏è Opening catalogue...');
        setTimeout(() => { window.location.href = 'catalogue.html'; }, 1000);
    }

    function goHome() { window.location.href = 'index.html'; }

    function contactSupport() {
        const msg = encodeURIComponent(`Hello Quickshelf Support,\n\nName: ${customerData.name}\nPhone: ${customerData.phone}\n\nI need help with: `);
        window.open(`https://wa.me/254742258137?text=${msg}`, '_blank');
        showNotification('üì± Opening WhatsApp...');
    }

    function logout() {
        if (!confirm('Are you sure you want to logout?')) return;
        ['quickshelfLoggedIn','quickshelfUserType','quickshelfUserPhone','quickshelfUserEmail','quickshelfUserData'].forEach(k => storeRemove(k));
        showNotification('üëã Logged out');
        setTimeout(() => { window.location.href = 'index.html'; }, 1000);
    }

    function getInitials(name) {
        const p = name.trim().split(' ').filter(Boolean);
        if (!p.length) return 'U';
        if (p.length === 1) return p[0][0].toUpperCase();
        return (p[0][0] + p[p.length-1][0]).toUpperCase();
    }

    function showNotification(msg, isError = false) {
        const n = document.getElementById('notification');
        n.textContent = msg;
        n.className = `notification show${isError ? ' error' : ''}`;
        setTimeout(() => n.classList.remove('show'), 4000);
    }

    document.getElementById('orderDetailsModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
</body>
</html>
